<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verify Access - Friends Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <script type="module" src="gate.js"></script>

  <div class="auth-page fv">
    <div class="auth-box fv">
      <header class="auth-header">
        <div class="auth-title">Access Verification</div>
        <div class="auth-subtitle">Enter your access code</div>
      </header>

      <form class="auth-form" onsubmit="return false;">
        <div class="input-group">
          <label for="accessCode">Access Code</label>
          <div class="input-with-icon">
            <span class="icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 10V14M7 7.5V5C7 3.89543 7.89543 3 9 3H15C16.1046 3 17 3.89543 17 5V7.5M5 21H19C20.1046 21 21 20.1046 21 19V10C21 8.89543 20.1046 8 19 8H5C3.89543 8 3 8.89543 3 10V19C3 20.1046 3.89543 21 5 21Z" stroke="currentColor" stroke-width="1.5"/></svg>
            </span>
            <input id="accessCode" type="text" placeholder="Enter your access code" required />
          </div>
        </div>

        <div class="auth-actions">
          <button id="verifyBtn" type="button" class="btn btn-primary">Verify</button>
        </div>

        <div class="auth-links small">
          <a href="login.html">Back to login</a>
        </div>

        <div id="accessMsg" class="form-msg small" role="alert"></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const accessCode = document.getElementById('accessCode');
    const verifyBtn = document.getElementById('verifyBtn');
    const accessMsg = document.getElementById('accessMsg');

    // Valid access codes - in a real app, store these securely on the server
    const validCodes = ["FRIENDS2025", "CHAT2025"];

    function show(text, ok=false){
      accessMsg.textContent = text || '';
      accessMsg.style.color = ok ? 'var(--success)' : 'var(--danger)';
    }

    verifyBtn?.addEventListener('click', async () => {
      show('');
      
      if (!auth.currentUser) {
        show('You must be logged in to verify access. Please sign in first.');
        setTimeout(() => window.location.replace('login.html'), 2000);
        return;
      }
      
      // Verify access code
      if (!validCodes.includes(accessCode.value)) {
        show('Invalid access code. Please try again or contact admin.');
        return;
      }
      
      verifyBtn.disabled = true;
      try {
        // Update user's access status in Firestore
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
          accessVerified: true
        });
        
        show('Access verified successfully!', true);
        setTimeout(() => window.location.replace('index.html'), 1500);
      } catch(e) {
        console.warn(e);
        show('Verification failed. Please try again.');
      } finally {
        verifyBtn.disabled = false;
      }
    });

    accessCode?.addEventListener('keydown', e => { 
      if (e.key === 'Enter') verifyBtn.click(); 
    });
  </script>

  <script type="module" src="auth.js"></script>
</body>
</html>